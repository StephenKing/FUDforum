#!/usr/local/bin/php -q
<?php
/***************************************************************************
* copyright            : (C) 2001-2004 Advanced Internet Designs Inc.
* email                : forum@prohost.org
* $Id: create_file_list,v 1.14 2004/10/06 16:36:15 hackie Exp $
*
* This program is free software; you can redistribute it and/or modify it 
* under the terms of the GNU General Public License as published by the 
* Free Software Foundation; either version 2 of the License, or 
* (at your option) any later version.
***************************************************************************/

function create_file_archive($dir, $pdir)
{
	$data = '';

	$path = realpath($dir) . '/';

	$files = glob($path . '*');
	if ($files === FALSE) {
		w_err('cannot access "'.$path.'"');
	}

	if (!$files) { // no files in directory
		return;
	}

	$dd = str_replace($pdir, '', $dir);
	foreach ($files as $f) {
		switch (filetype($f)) {
			case 'file':
				$fdata = file_get_contents($f);
				$data .= '//' . basename($f) . '//' . fileperms($f) . '//' . $dd . '//' . md5($fdata) . '//' . strlen($fdata) . "//\n" . $fdata . "\n";
				break;
			case 'dir':
				$name = basename($f);
				if ($name == 'CVS') {
					continue;
				}
				$data .= '//' . $name . '//' . fileperms($f) . '//' . $dd . "//\n";
				$data .= create_file_archive($f, $pdir);
				break;
		}
	}

	return $data;
}

function w_err($msg, $exit=true)
{
	fwrite(STDERR, $msg . "\n"); 
	exit;
}
	ini_set('memory_limit', '64M');
	set_magic_quotes_runtime(0);

	if (!defined('STDERR')) {
		define('STDERR', fopen('php://stderr', 'wb'));
	}

	if (!isset($_SERVER['argv'][1]) ) {
		w_err("No Arguments\n\tSyntax: ./create_file_list directory_name [use compression]");
	} else if (!@is_dir($_SERVER['argv'][1])) {
		w_err("Supplied Argument [".$_SERVER['argv'][1]."] is not a valid directory");
	}

	if (isset($_SERVER['argv'][2]) && !extension_loaded('zlib')) {
		w_err('zlib extension required to compress the archive is not loaded.');
	}	

	$_SERVER['argv'][1] = preg_replace('!/+$!', '', $_SERVER['argv'][1]);

	$archive = create_file_archive($_SERVER['argv'][1], getcwd());
	$check_sum = md5($archive);

	$clean = array('<?' => 'PHP_OPEN_TAG', '<%' => 'PHP_OPEN_ASP_TAG');
	
	if (isset($_SERVER['argv'][2])) {
		$a_len = str_pad(strlen($archive), 10, '0', STR_PAD_LEFT);
		echo $check_sum . $a_len . strtr(gzcompress($archive, 9), $clean);
	} else {
		$clean['<?'] = 'RAW_PHP_OPEN_TAG';
		echo $check_sum . strtr($archive, $clean);
	}	
?>